{***********************************************************************************************************************
 *
 * TERRA Game Engine
 * ==========================================
 *
 * Copyright (C) 2003, 2014 by Sérgio Flores (relfos@gmail.com)
 *
 ***********************************************************************************************************************
 *
 * Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
 * an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations under the License.
 *
 **********************************************************************************************************************
 * TERRA_SSAO
 * Implements screen-space screen occlusion effect
 ***********************************************************************************************************************
}
Unit TERRA_SSAO;

Interface
Uses TERRA_Utils, TERRA_Shader, TERRA_ScreenFX, TERRA_Texture, TERRA_IO, TERRA_FileManager;

Type
  SSAOFX = Class(ScreenFX)
    Protected
      _Texture:Texture;

    Public
      Procedure SetupUniforms(Sh:Shader; Var TextureSlot:Integer); Override;
      Procedure GenerateUniforms(); Override;
      Procedure GenerateFunctions(); Override;
      Procedure GenerateCode(); Override;
  End;

Const
random_Size = 4596;
random_data:Array[0..4595] Of Byte=($89,$50,$4E,$47,$0D,$0A,$1A,$0A,$00,$00,$00,$0D,$49,$48,$44,$52,$00,$00,$00,$20,$00,$00,$00,$20,$08,$02,$00,$00,$00,$FC,$18,$ED,$A3,$00,$00,$00,$09,$70,$48,$59,$73,
$00,$00,$0B,$13,$00,$00,$0B,$13,$01,$00,$9A,$9C,$18,$00,$00,$0A,$4F,$69,$43,$43,$50,$50,$68,$6F,$74,$6F,$73,$68,$6F,$70,$20,$49,$43,$43,$20,$70,$72,$6F,$66,$69,$6C,
$65,$00,$00,$78,$DA,$9D,$53,$67,$54,$53,$E9,$16,$3D,$F7,$DE,$F4,$42,$4B,$88,$80,$94,$4B,$6F,$52,$15,$08,$20,$52,$42,$8B,$80,$14,$91,$26,$2A,$21,$09,$10,$4A,$88,$21,
$A1,$D9,$15,$51,$C1,$11,$45,$45,$04,$1B,$C8,$A0,$88,$03,$8E,$8E,$80,$8C,$15,$51,$2C,$0C,$8A,$0A,$D8,$07,$E4,$21,$A2,$8E,$83,$A3,$88,$8A,$CA,$FB,$E1,$7B,$A3,$6B,$D6,
$BC,$F7,$E6,$CD,$FE,$B5,$D7,$3E,$E7,$AC,$F3,$9D,$B3,$CF,$07,$C0,$08,$0C,$96,$48,$33,$51,$35,$80,$0C,$A9,$42,$1E,$11,$E0,$83,$C7,$C4,$C6,$E1,$E4,$2E,$40,$81,$0A,$24,
$70,$00,$10,$08,$B3,$64,$21,$73,$FD,$23,$01,$00,$F8,$7E,$3C,$3C,$2B,$22,$C0,$07,$BE,$00,$01,$78,$D3,$0B,$08,$00,$C0,$4D,$9B,$C0,$30,$1C,$87,$FF,$0F,$EA,$42,$99,$5C,
$01,$80,$84,$01,$C0,$74,$91,$38,$4B,$08,$80,$14,$00,$40,$7A,$8E,$42,$A6,$00,$40,$46,$01,$80,$9D,$98,$26,$53,$00,$A0,$04,$00,$60,$CB,$63,$62,$E3,$00,$50,$2D,$00,$60,
$27,$7F,$E6,$D3,$00,$80,$9D,$F8,$99,$7B,$01,$00,$5B,$94,$21,$15,$01,$A0,$91,$00,$20,$13,$65,$88,$44,$00,$68,$3B,$00,$AC,$CF,$56,$8A,$45,$00,$58,$30,$00,$14,$66,$4B,
$C4,$39,$00,$D8,$2D,$00,$30,$49,$57,$66,$48,$00,$B0,$B7,$00,$C0,$CE,$10,$0B,$B2,$00,$08,$0C,$00,$30,$51,$88,$85,$29,$00,$04,$7B,$00,$60,$C8,$23,$23,$78,$00,$84,$99,
$00,$14,$46,$F2,$57,$3C,$F1,$2B,$AE,$10,$E7,$2A,$00,$00,$78,$99,$B2,$3C,$B9,$24,$39,$45,$81,$5B,$08,$2D,$71,$07,$57,$57,$2E,$1E,$28,$CE,$49,$17,$2B,$14,$36,$61,$02,
$61,$9A,$40,$2E,$C2,$79,$99,$19,$32,$81,$34,$0F,$E0,$F3,$CC,$00,$00,$A0,$91,$15,$11,$E0,$83,$F3,$FD,$78,$CE,$0E,$AE,$CE,$CE,$36,$8E,$B6,$0E,$5F,$2D,$EA,$BF,$06,$FF,
$22,$62,$62,$E3,$FE,$E5,$CF,$AB,$70,$40,$00,$00,$E1,$74,$7E,$D1,$FE,$2C,$2F,$B3,$1A,$80,$3B,$06,$80,$6D,$FE,$A2,$25,$EE,$04,$68,$5E,$0B,$A0,$75,$F7,$8B,$66,$B2,$0F,
$40,$B5,$00,$A0,$E9,$DA,$57,$F3,$70,$F8,$7E,$3C,$3C,$45,$A1,$90,$B9,$D9,$D9,$E5,$E4,$E4,$D8,$4A,$C4,$42,$5B,$61,$CA,$57,$7D,$FE,$67,$C2,$5F,$C0,$57,$FD,$6C,$F9,$7E,
$3C,$FC,$F7,$F5,$E0,$BE,$E2,$24,$81,$32,$5D,$81,$47,$04,$F8,$E0,$C2,$CC,$F4,$4C,$A5,$1C,$CF,$92,$09,$84,$62,$DC,$E6,$8F,$47,$FC,$B7,$0B,$FF,$FC,$1D,$D3,$22,$C4,$49,
$62,$B9,$58,$2A,$14,$E3,$51,$12,$71,$8E,$44,$9A,$8C,$F3,$32,$A5,$22,$89,$42,$92,$29,$C5,$25,$D2,$FF,$64,$E2,$DF,$2C,$FB,$03,$3E,$DF,$35,$00,$B0,$6A,$3E,$01,$7B,$91,
$2D,$A8,$5D,$63,$03,$F6,$4B,$27,$10,$58,$74,$C0,$E2,$F7,$00,$00,$F2,$BB,$6F,$C1,$D4,$28,$08,$03,$80,$68,$83,$E1,$CF,$77,$FF,$EF,$3F,$FD,$47,$A0,$25,$00,$80,$66,$49,
$92,$71,$00,$00,$5E,$44,$24,$2E,$54,$CA,$B3,$3F,$C7,$08,$00,$00,$44,$A0,$81,$2A,$B0,$41,$1B,$F4,$C1,$18,$2C,$C0,$06,$1C,$C1,$05,$DC,$C1,$0B,$FC,$60,$36,$84,$42,$24,
$C4,$C2,$42,$10,$42,$0A,$64,$80,$1C,$72,$60,$29,$AC,$82,$42,$28,$86,$CD,$B0,$1D,$2A,$60,$2F,$D4,$40,$1D,$34,$C0,$51,$68,$86,$93,$70,$0E,$2E,$C2,$55,$B8,$0E,$3D,$70,
$0F,$FA,$61,$08,$9E,$C1,$28,$BC,$81,$09,$04,$41,$C8,$08,$13,$61,$21,$DA,$88,$01,$62,$8A,$58,$23,$8E,$08,$17,$99,$85,$F8,$21,$C1,$48,$04,$12,$8B,$24,$20,$C9,$88,$14,
$51,$22,$4B,$91,$35,$48,$31,$52,$8A,$54,$20,$55,$48,$1D,$F2,$3D,$72,$02,$39,$87,$5C,$46,$BA,$91,$3B,$C8,$00,$32,$82,$FC,$86,$BC,$47,$31,$94,$81,$B2,$51,$3D,$D4,$0C,
$B5,$43,$B9,$A8,$37,$1A,$84,$46,$A2,$0B,$D0,$64,$74,$31,$9A,$8F,$16,$A0,$9B,$D0,$72,$B4,$1A,$3D,$8C,$36,$A1,$E7,$D0,$AB,$68,$0F,$DA,$8F,$3E,$43,$C7,$30,$C0,$E8,$18,
$07,$33,$C4,$6C,$30,$2E,$C6,$C3,$42,$B1,$38,$2C,$09,$93,$63,$CB,$B1,$22,$AC,$0C,$AB,$C6,$1A,$B0,$56,$AC,$03,$BB,$89,$F5,$63,$CF,$B1,$77,$04,$12,$81,$45,$C0,$09,$36,
$04,$77,$42,$20,$61,$1E,$41,$48,$58,$4C,$58,$4E,$D8,$48,$A8,$20,$1C,$24,$34,$11,$DA,$09,$37,$09,$03,$84,$51,$C2,$27,$22,$93,$A8,$4B,$B4,$26,$BA,$11,$F9,$C4,$18,$62,
$32,$31,$87,$58,$48,$2C,$23,$D6,$12,$8F,$13,$2F,$10,$7B,$88,$43,$C4,$37,$24,$12,$89,$43,$32,$27,$B9,$90,$02,$49,$B1,$A4,$54,$D2,$12,$D2,$46,$D2,$6E,$52,$23,$E9,$2C,
$A9,$9B,$34,$48,$1A,$23,$93,$C9,$DA,$64,$6B,$B2,$07,$39,$94,$2C,$20,$2B,$C8,$85,$E4,$9D,$E4,$C3,$E4,$33,$E4,$1B,$E4,$21,$F2,$5B,$0A,$9D,$62,$40,$71,$A4,$F8,$53,$E2,
$28,$52,$CA,$6A,$4A,$19,$E5,$10,$E5,$34,$E5,$06,$65,$98,$32,$41,$55,$A3,$9A,$52,$DD,$A8,$A1,$54,$11,$35,$8F,$5A,$42,$AD,$A1,$B6,$52,$AF,$51,$87,$A8,$13,$34,$75,$9A,
$39,$CD,$83,$16,$49,$4B,$A5,$AD,$A2,$95,$D3,$1A,$68,$17,$68,$F7,$69,$AF,$E8,$74,$BA,$11,$DD,$95,$1E,$4E,$97,$D0,$57,$D2,$CB,$E9,$47,$E8,$97,$E8,$03,$F4,$77,$0C,$0D,
$86,$15,$83,$C7,$88,$67,$28,$19,$9B,$18,$07,$18,$67,$19,$77,$18,$AF,$98,$4C,$A6,$19,$D3,$8B,$19,$C7,$54,$30,$37,$31,$EB,$98,$E7,$99,$0F,$99,$6F,$55,$58,$2A,$B6,$2A,
$7C,$15,$91,$CA,$0A,$95,$4A,$95,$26,$95,$1B,$2A,$2F,$54,$A9,$AA,$A6,$AA,$DE,$AA,$0B,$55,$F3,$55,$CB,$54,$8F,$A9,$5E,$53,$7D,$AE,$46,$55,$33,$53,$E3,$A9,$09,$D4,$96,
$AB,$55,$AA,$9D,$50,$EB,$53,$1B,$53,$67,$A9,$3B,$A8,$87,$AA,$67,$A8,$6F,$54,$3F,$A4,$7E,$59,$FD,$89,$06,$59,$C3,$4C,$C3,$4F,$43,$A4,$51,$A0,$B1,$5F,$E3,$BC,$C6,$20,
$0B,$63,$19,$B3,$78,$2C,$21,$6B,$0D,$AB,$86,$75,$81,$35,$C4,$26,$B1,$CD,$D9,$7C,$76,$2A,$BB,$98,$FD,$1D,$BB,$8B,$3D,$AA,$A9,$A1,$39,$43,$33,$4A,$33,$57,$B3,$52,$F3,
$94,$66,$3F,$07,$E3,$98,$71,$F8,$9C,$74,$4E,$09,$E7,$28,$A7,$97,$F3,$7E,$8A,$DE,$14,$EF,$29,$E2,$29,$1B,$A6,$34,$4C,$B9,$31,$65,$5C,$6B,$AA,$96,$97,$96,$58,$AB,$48,
$AB,$51,$AB,$47,$EB,$BD,$36,$AE,$ED,$A7,$9D,$A6,$BD,$45,$BB,$59,$FB,$81,$0E,$41,$C7,$4A,$27,$5C,$27,$47,$67,$8F,$CE,$05,$9D,$E7,$53,$D9,$53,$DD,$A7,$0A,$A7,$16,$4D,
$3D,$3A,$F5,$AE,$2E,$AA,$6B,$A5,$1B,$A1,$BB,$44,$77,$BF,$6E,$A7,$EE,$98,$9E,$BE,$5E,$80,$9E,$4C,$6F,$A7,$DE,$79,$BD,$E7,$FA,$1C,$7D,$2F,$FD,$54,$FD,$6D,$FA,$A7,$F5,
$47,$0C,$58,$06,$B3,$0C,$24,$06,$DB,$0C,$CE,$18,$3C,$C5,$35,$71,$6F,$3C,$1D,$2F,$C7,$DB,$F1,$51,$43,$5D,$C3,$40,$43,$A5,$61,$95,$61,$97,$E1,$84,$91,$B9,$D1,$3C,$A3,
$D5,$46,$8D,$46,$0F,$8C,$69,$C6,$5C,$E3,$24,$E3,$6D,$C6,$6D,$C6,$A3,$26,$06,$26,$21,$26,$4B,$4D,$EA,$4D,$EE,$9A,$52,$4D,$B9,$A6,$29,$A6,$3B,$4C,$3B,$4C,$C7,$CD,$CC,
$CD,$A2,$CD,$D6,$99,$35,$9B,$3D,$31,$D7,$32,$E7,$9B,$E7,$9B,$D7,$9B,$DF,$B7,$60,$5A,$78,$5A,$2C,$B6,$A8,$B6,$B8,$65,$49,$B2,$E4,$5A,$A6,$59,$EE,$B6,$BC,$6E,$85,$5A,
$39,$59,$A5,$58,$55,$5A,$5D,$B3,$46,$AD,$9D,$AD,$25,$D6,$BB,$AD,$BB,$A7,$11,$A7,$B9,$4E,$93,$4E,$AB,$9E,$D6,$67,$C3,$B0,$F1,$B6,$C9,$B6,$A9,$B7,$19,$B0,$E5,$D8,$06,
$DB,$AE,$B6,$6D,$B6,$7D,$61,$67,$62,$17,$67,$B7,$C5,$AE,$C3,$EE,$93,$BD,$93,$7D,$BA,$7D,$8D,$FD,$3D,$07,$0D,$87,$D9,$0E,$AB,$1D,$5A,$1D,$7E,$73,$B4,$72,$14,$3A,$56,
$3A,$DE,$9A,$CE,$9C,$EE,$3F,$7D,$C5,$F4,$96,$E9,$2F,$67,$58,$CF,$10,$CF,$D8,$33,$E3,$B6,$13,$CB,$29,$C4,$69,$9D,$53,$9B,$D3,$47,$67,$17,$67,$B9,$73,$83,$F3,$88,$8B,
$89,$4B,$82,$CB,$2E,$97,$3E,$2E,$9B,$1B,$C6,$DD,$C8,$BD,$E4,$4A,$74,$F5,$71,$5D,$E1,$7A,$D2,$F5,$9D,$9B,$B3,$9B,$C2,$ED,$A8,$DB,$AF,$EE,$36,$EE,$69,$EE,$87,$DC,$9F,
$CC,$34,$9F,$29,$9E,$59,$33,$73,$D0,$C3,$C8,$43,$E0,$51,$E5,$D1,$3F,$0B,$9F,$95,$30,$6B,$DF,$AC,$7E,$4F,$43,$4F,$81,$67,$B5,$E7,$23,$2F,$63,$2F,$91,$57,$AD,$D7,$B0,
$B7,$A5,$77,$AA,$F7,$61,$EF,$17,$3E,$F6,$3E,$72,$9F,$E3,$3E,$E3,$3C,$37,$DE,$32,$DE,$59,$5F,$CC,$37,$C0,$B7,$C8,$B7,$CB,$4F,$C3,$6F,$9E,$5F,$85,$DF,$43,$7F,$23,$FF,
$64,$FF,$7A,$FF,$D1,$00,$A7,$80,$25,$01,$67,$03,$89,$81,$41,$81,$5B,$02,$FB,$F8,$7A,$7C,$21,$BF,$8E,$3F,$3A,$DB,$65,$F6,$B2,$D9,$ED,$41,$8C,$A0,$B9,$41,$15,$41,$8F,
$82,$AD,$82,$E5,$C1,$AD,$21,$68,$C8,$EC,$90,$AD,$21,$F7,$E7,$98,$CE,$91,$CE,$69,$0E,$85,$50,$7E,$E8,$D6,$D0,$07,$61,$E6,$61,$8B,$C3,$7E,$0C,$27,$85,$87,$85,$57,$86,
$3F,$8E,$70,$88,$58,$1A,$D1,$31,$97,$35,$77,$D1,$DC,$43,$73,$DF,$44,$FA,$44,$96,$44,$DE,$9B,$67,$31,$4F,$39,$AF,$2D,$4A,$35,$2A,$3E,$AA,$2E,$6A,$3C,$DA,$37,$BA,$34,
$BA,$3F,$C6,$2E,$66,$59,$CC,$D5,$58,$9D,$58,$49,$6C,$4B,$1C,$39,$2E,$2A,$AE,$36,$6E,$6C,$BE,$DF,$FC,$ED,$F3,$87,$E2,$9D,$E2,$0B,$E3,$7B,$17,$98,$2F,$C8,$5D,$70,$79,
$A1,$CE,$C2,$F4,$85,$A7,$16,$A9,$2E,$12,$2C,$3A,$96,$40,$4C,$88,$4E,$38,$94,$F0,$41,$10,$2A,$A8,$16,$8C,$25,$F2,$13,$77,$25,$8E,$0A,$79,$C2,$1D,$C2,$67,$22,$2F,$D1,
$36,$D1,$88,$D8,$43,$5C,$2A,$1E,$4E,$F2,$48,$2A,$4D,$7A,$92,$EC,$91,$BC,$35,$79,$24,$C5,$33,$A5,$2C,$E5,$B9,$84,$27,$A9,$90,$BC,$4C,$0D,$4C,$DD,$9B,$3A,$9E,$16,$9A,
$76,$20,$6D,$32,$3D,$3A,$BD,$31,$83,$92,$91,$90,$71,$42,$AA,$21,$4D,$93,$B6,$67,$EA,$67,$E6,$66,$76,$CB,$AC,$65,$85,$B2,$FE,$C5,$6E,$8B,$B7,$2F,$1E,$95,$07,$C9,$6B,
$B3,$90,$AC,$05,$59,$2D,$0A,$B6,$42,$A6,$E8,$54,$5A,$28,$D7,$2A,$07,$B2,$67,$65,$57,$66,$BF,$CD,$89,$CA,$39,$96,$AB,$9E,$2B,$CD,$ED,$CC,$B3,$CA,$DB,$90,$37,$9C,$EF,
$9F,$FF,$ED,$12,$C2,$12,$E1,$92,$B6,$A5,$86,$4B,$57,$2D,$1D,$58,$E6,$BD,$AC,$6A,$39,$B2,$3C,$71,$79,$DB,$0A,$E3,$15,$05,$2B,$86,$56,$06,$AC,$3C,$B8,$8A,$B6,$2A,$6D,
$D5,$4F,$AB,$ED,$57,$97,$AE,$7E,$BD,$26,$7A,$4D,$6B,$81,$5E,$C1,$CA,$82,$C1,$B5,$01,$6B,$EB,$0B,$55,$0A,$E5,$85,$7D,$EB,$DC,$D7,$ED,$5D,$4F,$58,$2F,$59,$DF,$B5,$61,
$FA,$86,$9D,$1B,$3E,$15,$89,$8A,$AE,$14,$DB,$17,$97,$15,$7F,$D8,$28,$DC,$78,$E5,$1B,$87,$6F,$CA,$BF,$99,$DC,$94,$B4,$A9,$AB,$C4,$B9,$64,$CF,$66,$D2,$66,$E9,$E6,$DE,
$2D,$9E,$5B,$0E,$96,$AA,$97,$E6,$97,$0E,$6E,$0D,$D9,$DA,$B4,$0D,$DF,$56,$B4,$ED,$F5,$F6,$45,$DB,$2F,$97,$CD,$28,$DB,$BB,$83,$B6,$43,$B9,$A3,$BF,$3C,$B8,$BC,$65,$A7,
$C9,$CE,$CD,$3B,$3F,$54,$A4,$54,$F4,$54,$FA,$54,$36,$EE,$D2,$DD,$B5,$61,$D7,$F8,$6E,$D1,$EE,$1B,$7B,$BC,$F6,$34,$EC,$D5,$DB,$5B,$BC,$F7,$FD,$3E,$C9,$BE,$DB,$55,$01,
$55,$4D,$D5,$66,$D5,$65,$FB,$49,$FB,$B3,$F7,$3F,$AE,$89,$AA,$E9,$F8,$96,$FB,$6D,$5D,$AD,$4E,$6D,$71,$ED,$C7,$03,$D2,$03,$FD,$07,$23,$0E,$B6,$D7,$B9,$D4,$D5,$1D,$D2,
$3D,$54,$52,$8F,$D6,$2B,$EB,$47,$0E,$C7,$1F,$BE,$FE,$9D,$EF,$77,$2D,$0D,$36,$0D,$55,$8D,$9C,$C6,$E2,$23,$70,$44,$79,$E4,$E9,$F7,$09,$DF,$F7,$1E,$0D,$3A,$DA,$76,$8C,
$7B,$AC,$E1,$07,$D3,$1F,$76,$1D,$67,$1D,$2F,$6A,$42,$9A,$F2,$9A,$46,$9B,$53,$9A,$FB,$5B,$62,$5B,$BA,$4F,$CC,$3E,$D1,$D6,$EA,$DE,$7A,$FC,$47,$DB,$1F,$0F,$9C,$34,$3C,
$59,$79,$4A,$F3,$54,$C9,$69,$DA,$E9,$82,$D3,$93,$67,$F2,$CF,$8C,$9D,$95,$9D,$7D,$7E,$2E,$F9,$DC,$60,$DB,$A2,$B6,$7B,$E7,$63,$CE,$DF,$6A,$0F,$6F,$EF,$BA,$10,$74,$E1,
$D2,$45,$FF,$8B,$E7,$3B,$BC,$3B,$CE,$5C,$F2,$B8,$74,$F2,$B2,$DB,$E5,$13,$57,$B8,$57,$9A,$AF,$3A,$5F,$6D,$EA,$74,$EA,$3C,$FE,$93,$D3,$4F,$C7,$BB,$9C,$BB,$9A,$AE,$B9,
$5C,$6B,$B9,$EE,$7A,$BD,$B5,$7B,$66,$F7,$E9,$1B,$9E,$37,$CE,$DD,$F4,$BD,$79,$F1,$16,$FF,$D6,$D5,$9E,$39,$3D,$DD,$BD,$F3,$7A,$6F,$F7,$C5,$F7,$F5,$DF,$16,$DD,$7E,$72,
$27,$FD,$CE,$CB,$BB,$D9,$77,$27,$EE,$AD,$BC,$4F,$BC,$5F,$F4,$40,$ED,$41,$D9,$43,$DD,$87,$D5,$3F,$5B,$FE,$DC,$D8,$EF,$DC,$7F,$6A,$C0,$77,$A0,$F3,$D1,$DC,$47,$F7,$06,
$85,$83,$CF,$FE,$91,$F5,$8F,$0F,$43,$05,$8F,$99,$8F,$CB,$86,$0D,$86,$EB,$9E,$38,$3E,$39,$39,$E2,$3F,$72,$FD,$E9,$FC,$A7,$43,$CF,$64,$CF,$26,$9E,$17,$FE,$A2,$FE,$CB,
$AE,$17,$16,$2F,$7E,$F8,$D5,$EB,$D7,$CE,$D1,$98,$D1,$A1,$97,$F2,$97,$93,$BF,$6D,$7C,$A5,$FD,$EA,$C0,$EB,$19,$AF,$DB,$C6,$C2,$C6,$1E,$BE,$C9,$78,$33,$31,$5E,$F4,$56,
$FB,$ED,$C1,$77,$DC,$77,$1D,$EF,$A3,$DF,$0F,$4F,$E4,$7C,$20,$7F,$28,$FF,$68,$F9,$B1,$F5,$53,$D0,$A7,$FB,$93,$19,$93,$93,$FF,$04,$03,$98,$F3,$FC,$63,$33,$2D,$DB,$00,
$00,$00,$20,$63,$48,$52,$4D,$00,$00,$7A,$25,$00,$00,$80,$83,$00,$00,$F9,$FF,$00,$00,$80,$E9,$00,$00,$75,$30,$00,$00,$EA,$60,$00,$00,$3A,$98,$00,$00,$17,$6F,$92,$5F,
$C5,$46,$00,$00,$07,$1F,$49,$44,$41,$54,$78,$DA,$44,$96,$7D,$74,$8F,$F7,$19,$C6,$3F,$1D,$E5,$D7,$86,$73,$D2,$53,$65,$E6,$AD,$51,$5B,$55,$4B,$77,$66,$88,$B7,$D1,$46,
$DA,$28,$47,$D1,$69,$8B,$A2,$65,$96,$A8,$45,$08,$A1,$C9,$68,$95,$4E,$04,$41,$97,$A6,$AA,$98,$B4,$45,$F5,$85,$4E,$17,$7D,$B5,$A8,$78,$09,$AB,$53,$F5,$52,$49,$17,$41,
$A8,$14,$25,$34,$68,$93,$B0,$7E,$F6,$C7,$F3,$44,$9F,$FF,$BE,$E7,$7C,$9F,$E7,$BA,$EE,$EB,$BE,$AE,$FB,$B9,$41,$93,$70,$CD,$45,$75,$63,$21,$8A,$BE,$8F,$99,$BD,$E1,$90,
$28,$25,$88,$05,$15,$B5,$6F,$7D,$5B,$82,$E0,$10,$FA,$4E,$0A,$AE,$09,$4C,$44,$35,$38,$AA,$8E,$E5,$E5,$ED,$00,$36,$19,$1A,$17,$4D,$53,$6E,$93,$99,$85,$3A,$C1,$D9,$AE,
$AE,$9C,$6C,$0A,$CE,$DD,$2A,$D1,$6A,$AD,$DD,$1E,$46,$A5,$39,$D9,$A9,$A2,$CC,$F6,$2E,$AD,$11,$3B,$68,$24,$59,$E5,$F8,$A3,$68,$0B,$18,$AE,$BA,$09,$01,$6D,$8F,$F9,$C4,
$F5,$18,$84,$CF,$6C,$A0,$0C,$C8,$59,$AD,$C6,$ED,$A3,$5F,$BE,$C2,$27,$79,$8E,$C5,$B4,$80,$D2,$21,$9E,$57,$C1,$0F,$45,$BC,$C7,$79,$0B,$30,$F6,$1D,$FC,$9D,$60,$DE,$97,
$13,$6F,$01,$D9,$21,$6C,$04,$47,$EF,$0F,$AB,$70,$E6,$DD,$22,$0F,$CB,$C7,$D7,$8E,$8B,$A0,$1E,$53,$25,$AE,$E1,$D6,$63,$28,$2B,$D7,$1A,$4B,$AE,$B2,$F3,$AF,$27,$2D,$5D,
$7C,$EE,$80,$F6,$6C,$7E,$66,$C8,$E8,$E7,$CC,$A7,$BC,$C8,$31,$22,$13,$5D,$3B,$43,$CE,$54,$B6,$9B,$D5,$D6,$07,$50,$49,$F1,$E2,$5A,$CD,$91,$51,$E2,$85,$F7,$4B,$CD,$6C,
$D1,$9F,$13,$D4,$2E,$D1,$D3,$19,$8A,$29,$54,$17,$29,$1E,$D3,$D3,$56,$07,$C0,$6C,$37,$0D,$57,$AA,$A3,$C4,$92,$73,$78,$C3,$DB,$0A,$E2,$7A,$3A,$79,$FD,$01,$ED,$84,$AE,
$C4,$2B,$26,$A9,$5A,$B3,$47,$45,$04,$E0,$33,$B5,$65,$3C,$C8,$20,$B5,$51,$7D,$F4,$7B,$E6,$A9,$37,$07,$B7,$96,$64,$6B,$76,$D0,$CC,$69,$9B,$5D,$D6,$D4,$04,$57,$F2,$5C,
$EC,$62,$3D,$5C,$A1,$4B,$C3,$3E,$E7,$1D,$B3,$B2,$34,$90,$F7,$54,$BA,$62,$34,$E0,$D1,$3E,$7F,$F6,$5D,$23,$EE,$BE,$5F,$AD,$30,$10,$6D,$97,$36,$51,$AA,$E1,$69,$55,$26,
$FE,$05,$FD,$4E,$71,$EA,$2C,$26,$CD,$5E,$AE,$0D,$44,$69,$E2,$9E,$C4,$A1,$84,$35,$34,$44,$DF,$3F,$20,$40,$50,$A4,$CB,$15,$4D,$DE,$AE,$9A,$0B,$00,$76,$19,$D5,$1C,$D7,
$2C,$39,$1D,$9C,$8A,$B1,$6D,$20,$D6,$5D,$79,$3F,$90,$A0,$2E,$41,$2B,$5A,$9D,$F5,$71,$AB,$9F,$38,$22,$59,$13,$8F,$36,$53,$BD,$EF,$00,$FA,$9E,$0B,$05,$CE,$18,$A5,$2F,
$A9,$4E,$A6,$82,$97,$8F,$C1,$41,$BE,$1D,$C8,$0E,$14,$98,$E7,$86,$42,$E5,$46,$D5,$BD,$6A,$86,$62,$04,$D8,$3F,$09,$F0,$25,$D1,$34,$D9,$31,$52,$BD,$52,$CE,$A7,$F7,$8E,
$D3,$14,$71,$14,$2F,$56,$A8,$8D,$41,$0B,$A6,$DD,$E4,$0B,$75,$09,$29,$F1,$27,$96,$EA,$65,$54,$BB,$73,$C7,$B2,$05,$1E,$19,$E2,$63,$BE,$8D,$D6,$33,$2A,$57,$53,$01,$85,
$52,$6E,$2B,$0A,$22,$D6,$FC,$7A,$D0,$7A,$08,$3B,$53,$07,$98,$2A,$7D,$F5,$30,$BB,$D0,$91,$84,$DD,$0D,$00,$DA,$AC,$FA,$42,$F5,$BF,$E1,$3B,$99,$0A,$FF,$43,$DD,$2A,$CC,
$BA,$8C,$FA,$A5,$6A,$51,$D2,$C6,$1A,$E5,$21,$02,$CB,$E0,$22,$55,$2F,$05,$90,$E8,$AF,$FC,$68,$26,$9A,$13,$7E,$39,$03,$5D,$71,$D3,$D7,$6F,$22,$87,$7D,$95,$4B,$A3,$D5,
$E2,$D3,$EA,$B2,$8B,$17,$34,$F2,$38,$A1,$DC,$F8,$01,$1F,$0A,$8C,$51,$13,$A1,$29,$FD,$5D,$7F,$27,$E1,$47,$4B,$02,$AA,$95,$E8,$AB,$6C,$2A,$49,$7E,$47,$A4,$C3,$AD,$4D,
$D1,$37,$77,$88,$85,$43,$45,$B7,$F9,$AF,$4C,$31,$CD,$3D,$A6,$06,$74,$D6,$38,$BC,$74,$EF,$98,$C4,$AB,$6B,$94,$DB,$43,$0B,$CE,$BD,$94,$91,$29,$91,$D3,$79,$4A,$BD,$0B,
$09,$44,$AC,$B5,$80,$25,$74,$54,$3F,$50,$4D,$0C,$50,$E9,$5B,$0B,$AE,$5F,$9F,$2E,$E8,$D7,$02,$7E,$F6,$CF,$68,$07,$1A,$78,$4B,$AC,$4F,$4B,$1B,$3A,$AF,$41,$BC,$EA,$6A,
$3D,$62,$B6,$9B,$B3,$13,$EA,$46,$1A,$5A,$E3,$CA,$1B,$8C,$4D,$99,$2F,$5A,$5F,$D1,$D5,$9D,$7F,$1E,$79,$94,$9D,$72,$84,$1A,$1D,$8E,$41,$D4,$1B,$02,$70,$CE,$E9,$8B,$26,
$AF,$A8,$F4,$B5,$C2,$47,$D5,$78,$48,$C9,$13,$37,$75,$0D,$AC,$5A,$C8,$F6,$3D,$F4,$74,$D0,$F6,$E2,$67,$B4,$CC,$29,$EE,$6B,$6B,$D8,$13,$E9,$C3,$B3,$55,$BB,$CD,$12,$9A,
$79,$F6,$C9,$6B,$E8,$4F,$9F,$FF,$26,$A0,$3D,$68,$AB,$AB,$A3,$ED,$AF,$49,$DD,$EE,$08,$40,$EB,$67,$BF,$2D,$B6,$24,$2A,$F1,$2E,$D3,$6A,$02,$57,$94,$DE,$6F,$91,$D8,$1E,
$27,$B5,$D0,$E1,$2A,$59,$D8,$8D,$9D,$A9,$41,$38,$E3,$84,$5D,$6E,$B0,$03,$3E,$0F,$B1,$2A,$0E,$DD,$2C,$6F,$29,$95,$43,$DA,$69,$D2,$05,$D5,$2B,$D0,$F3,$23,$B7,$E9,$78,
$46,$CA,$38,$B8,$EE,$37,$C5,$85,$BF,$B5,$00,$CD,$35,$ED,$F1,$E3,$5A,$22,$EA,$3B,$02,$31,$D6,$95,$32,$8A,$2D,$E1,$0B,$0F,$F2,$29,$87,$B7,$A1,$38,$CD,$95,$7D,$8A,$63,
$6D,$ED,$A1,$EF,$8C,$3C,$ED,$79,$B5,$EC,$67,$4D,$9B,$78,$AA,$AC,$D8,$C1,$46,$77,$41,$9E,$DC,$1B,$C3,$5E,$06,$2C,$F3,$68,$BC,$3A,$0C,$DD,$2D,$EB,$8C,$8D,$09,$D4,$1E,
$1B,$45,$2D,$B2,$47,$C0,$98,$73,$02,$71,$61,$73,$47,$34,$22,$5B,$95,$8F,$D1,$61,$5C,$56,$BB,$9C,$50,$1D,$6E,$95,$B4,$92,$62,$71,$40,$53,$DF,$D0,$C5,$99,$0E,$1C,$77,
$9D,$72,$58,$5C,$47,$DD,$7E,$5F,$B2,$B6,$51,$E5,$E0,$27,$1B,$55,$D7,$D9,$0D,$D5,$F1,$D1,$C1,$A5,$4C,$DC,$A6,$DA,$52,$8C,$3E,$1F,$AF,$E6,$20,$95,$C2,$66,$B1,$13,$80,
$7E,$6C,$77,$BC,$B6,$5C,$99,$2F,$3E,$18,$D6,$D9,$19,$74,$82,$53,$67,$D8,$D5,$32,$1D,$91,$B1,$3E,$8C,$0A,$27,$71,$B2,$D2,$FA,$E7,$6C,$03,$BE,$E2,$F7,$06,$FA,$CF,$2C,
$31,$72,$74,$B8,$42,$0F,$D5,$15,$21,$E9,$3F,$9A,$A9,$B2,$65,$8E,$C5,$BC,$AC,$D8,$A7,$53,$FA,$BB,$5F,$21,$11,$6F,$A7,$82,$CF,$41,$4E,$86,$53,$96,$28,$55,$D7,$98,$A5,
$72,$35,$99,$E1,$81,$9E,$8D,$FD,$E6,$D2,$63,$E7,$95,$A2,$54,$FF,$E0,$66,$BD,$3B,$54,$A3,$F7,$26,$7E,$8D,$68,$EE,$13,$9A,$A0,$56,$9F,$38,$08,$57,$22,$03,$0F,$2B,$9A,
$43,$9B,$07,$06,$68,$E7,$CF,$C8,$56,$89,$CF,$AE,$8B,$0F,$D7,$97,$83,$19,$63,$B5,$56,$29,$87,$B3,$BD,$6C,$80,$AD,$38,$8F,$7F,$BB,$D9,$7B,$5E,$41,$DF,$73,$F4,$14,$55,
$8B,$45,$CF,$B4,$E0,$36,$35,$39,$8E,$BC,$7E,$A0,$7C,$82,$63,$5F,$33,$0D,$99,$A5,$F4,$C3,$8D,$41,$AF,$1A,$D6,$61,$F0,$53,$0E,$08,$5D,$96,$CB,$55,$D3,$D5,$59,$CC,$55,
$6B,$CE,$EA,$38,$E5,$5E,$E1,$1A,$D1,$D8,$3E,$27,$24,$06,$50,$50,$8E,$B2,$C5,$E5,$0B,$44,$AD,$EA,$54,$8E,$6A,$87,$55,$75,$B4,$A7,$69,$1F,$55,$0E,$25,$13,$69,$53,$75,
$5E,$3D,$38,$20,$74,$6A,$B7,$15,$4D,$B0,$2C,$DF,$C1,$1E,$EF,$A2,$68,$0C,$F2,$7A,$86,$FB,$54,$87,$3D,$A4,$64,$D2,$D1,$58,$82,$C0,$55,$45,$2D,$CA,$42,$F6,$D8,$9A,$74,
$63,$EA,$C6,$47,$B1,$05,$26,$2A,$5B,$7C,$6C,$C1,$14,$FC,$BD,$55,$AD,$60,$99,$AE,$3A,$BE,$6A,$FC,$D0,$76,$8E,$0F,$90,$9A,$50,$AD,$7F,$52,$B9,$53,$D5,$09,$96,$28,$60,
$C6,$2E,$8D,$C0,$0B,$E2,$C1,$14,$1C,$18,$F8,$0D,$9D,$3B,$81,$2C,$61,$83,$AD,$D1,$7A,$4A,$9A,$27,$B5,$5E,$D8,$FD,$45,$EE,$D5,$AB,$AA,$0D,$AD,$DB,$6F,$32,$9E,$CA,$05,
$F2,$38,$89,$8B,$13,$2E,$29,$CD,$0B,$1C,$8D,$F9,$5A,$54,$17,$8C,$B5,$76,$A5,$EF,$EE,$76,$E0,$FA,$EE,$C2,$13,$65,$E6,$A2,$6F,$68,$AB,$AA,$A8,$9E,$AD,$FC,$45,$F1,$23,
$6A,$EF,$30,$40,$DF,$DD,$68,$E7,$66,$5E,$04,$93,$34,$DE,$6F,$4A,$14,$1B,$77,$4A,$8E,$D8,$06,$ED,$ED,$C1,$39,$D7,$54,$CD,$E9,$26,$48,$FE,$74,$BC,$75,$5D,$E8,$F6,$5E,
$DB,$5E,$CF,$9F,$BE,$8F,$23,$9A,$25,$CD,$7A,$69,$6B,$0F,$B4,$51,$12,$16,$3A,$07,$1B,$8B,$32,$C7,$5F,$3A,$D9,$B8,$46,$7A,$41,$C1,$C4,$D9,$F3,$34,$09,$49,$C7,$AC,$9D,
$5E,$EC,$85,$3A,$7D,$A0,$3F,$2A,$BE,$22,$65,$DE,$5A,$37,$B8,$4A,$06,$FB,$83,$32,$15,$70,$51,$30,$B4,$99,$20,$75,$52,$FC,$DD,$A7,$96,$CA,$6C,$F9,$50,$F9,$EA,$52,$10,
$8C,$C1,$85,$AA,$0B,$6B,$40,$E6,$FF,$5B,$5F,$EA,$8A,$BB,$5D,$C3,$7F,$A6,$77,$4F,$6C,$20,$56,$0F,$3E,$39,$09,$50,$17,$37,$F0,$C7,$61,$E5,$09,$96,$AE,$86,$4C,$2D,$9F,
$6F,$4F,$8F,$A7,$61,$33,$6C,$8F,$92,$11,$FE,$26,$9A,$A9,$99,$E1,$AC,$3A,$21,$54,$F9,$45,$D6,$CC,$16,$44,$2A,$5B,$AB,$3C,$A7,$33,$5C,$91,$AA,$57,$02,$B7,$2D,$F2,$2D,
$B7,$64,$5A,$1C,$9C,$B2,$48,$5F,$21,$3C,$45,$65,$B0,$DE,$F9,$88,$FB,$17,$AB,$F7,$A9,$FC,$43,$47,$F0,$AC,$D2,$FB,$48,$B0,$3D,$34,$5D,$27,$C7,$6E,$01,$58,$D0,$4F,$9C,
$30,$44,$9E,$0D,$3D,$8C,$3A,$9D,$98,$FE,$A2,$9E,$F1,$72,$B0,$2C,$7A,$2F,$D9,$22,$63,$D6,$FD,$7F,$00,$3D,$1B,$6B,$55,$22,$A1,$61,$1D,$00,$00,$00,$00,$49,$45,$4E,$44,
$AE,$42,$60,$82);

Implementation


Type
  SSAOProvider = Class(ResourceProvider)
    Function GetStream(Name:AnsiString): Stream; Override;
    Function HasStream(Name:AnsiString):Boolean; Override;
  End;

Function SSAOProvider.HasStream(Name:AnsiString):Boolean;
Begin
  Result := (Name='randomssao.png');
End;

Function SSAOProvider.GetStream(Name:AnsiString):Stream;
Begin
  If (Name='randomssao.png') Then
  Begin
    Result := MemoryStream.Create(random_size, @random_data[0]);
  End Else
    Result := Nil;
End;


{ SSAOFX }
Procedure SSAOFX.GenerateCode;
Begin
  //max AO intensity
  Line('mediump float AO_MAX = 0.25;');
  //scaling of intensity, bigger numbers -> sharper
  Line('mediump float AO_SCALE = 15.0;');
  //fall off, lower numbers -> more weighting towards corners
  Line('mediump float AO_FO = 0.75;');
  //default for SSAO is 0.5, with 1.0 there should be no change in color on un-occluded areas
  Line('mediump float AO_BRIGHTNESS  = 0.5; ');


  Line('vec2 RandNrm    =   normalize(texture2D(randomTexture,fract(texCoord.xy*vec2(1024.0/32.0,700.0/32.0))).xy*2.0-1.0);');
  Line('mediump float Depth     =   texture2D(normal_texture, texCoord.xy).a;');

  Line('mediump float AO=0.0;');
  Line('AO  +=  texture2D(normal_texture, texCoord.xy+Refl(RandNrm,vec2( 1.0/1024.0, 0.0/700.0)*1.0)).a*pow(AO_FO,1.0);');
  Line('AO  +=  texture2D(normal_texture, texCoord.xy+Refl(RandNrm,vec2( 0.0/1024.0,-1.0/700.0)*2.0)).a*pow(AO_FO,2.0);');
  Line('AO  +=  texture2D(normal_texture, texCoord.xy+Refl(RandNrm,vec2(-1.0/1024.0, 0.0/700.0)*3.0)).a*pow(AO_FO,3.0);');
  Line('AO  +=  texture2D(normal_texture, texCoord.xy+Refl(RandNrm,vec2( 0.0/1024.0, 1.0/700.0)*4.0)).a*pow(AO_FO,4.0);');
  Line('AO  +=  texture2D(normal_texture, texCoord.xy+Refl(RandNrm,vec2( 1.0/1024.0, 1.0/700.0)*5.0)).a*pow(AO_FO,5.0);');
  Line('AO  +=  texture2D(normal_texture, texCoord.xy+Refl(RandNrm,vec2(-1.0/1024.0,-1.0/700.0)*6.0)).a*pow(AO_FO,6.0);');
  Line('AO  +=  texture2D(normal_texture, texCoord.xy+Refl(RandNrm,vec2(-1.0/1024.0, 1.0/700.0)*7.0)).a*pow(AO_FO,7.0);');
  Line('AO  +=  texture2D(normal_texture, texCoord.xy+Refl(RandNrm,vec2( 1.0/1024.0,-1.0/700.0)*8.0)).a*pow(AO_FO,8.0);');
  Line('AO  *=  1.0/(pow(AO_FO,1.0)+pow(AO_FO,2.0)+pow(AO_FO,3.0)+pow(AO_FO,4.0)+pow(AO_FO,5.0)+pow(AO_FO,6.0)+pow(AO_FO,7.0)+pow(AO_FO,8.0));');
  Line('AO  =   min((AO-Depth)*AO_SCALE,AO_MAX)+AO_BRIGHTNESS;');

  Line('output_color *= vec4(AO, AO, AO, 1.0);');
End;

procedure SSAOFX.GenerateFunctions;
begin
  inherited;
  Line('vec2 Refl(vec2 N,vec2 R){');
  Line('return R-2.0*dot(N,R)*N;}');
End;

Procedure SSAOFX.GenerateUniforms;
Begin
  Line('uniform sampler2D randomTexture;');
  Self.RequireTarget(captureTargetNormal);
End;

Procedure SSAOFX.SetupUniforms(Sh: Shader; Var TextureSlot:Integer);
Begin
  Inherited;

  If _Texture = Nil Then
  Begin
    FileManager.Instance.AddResourceProvider(SSAOProvider.Create);
    _Texture := TextureManager.Instance.GetTexture('randomssao');
  End;

  _Texture.Bind(_Texture, TextureSlot);
  Sh.SetUniform('randomTexture', TextureSlot);
  Inc(TextureSlot);
End;

End.